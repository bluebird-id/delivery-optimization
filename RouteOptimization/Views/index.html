<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Demo Logistik</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.2.2/ol.min.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.2.2/ol.css"> -->
    <style>
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      #map .ol-zoom {
        left: unset;
        right: 8px;
        top: unset;
        bottom: 30px;
      }

      .popover-body td {
        padding: 0 0.5em;
        text-align: right;
      }

      #sidebar {
        width: 400px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="popup"></div>
    <aside id="sidebar" class="position-relative m-3">
      <nav>
        <div class="nav nav-tabs bg-light pt-2 px-2" id="nav-tab" role="tablist">
          <button class="nav-link active" id="nav-request-tab" data-bs-toggle="tab" data-bs-target="#nav-request" type="button" role="tab" aria-controls="nav-request" aria-selected="true">Request</button>
          <button class="nav-link" id="nav-json-tab" data-bs-toggle="tab" data-bs-target="#nav-json" type="button" role="tab" aria-controls="nav-json" aria-selected="false">Draw from JSON</button>
        </div>
      </nav>
      <div class="tab-content p-3 bg-white">
        <div class="tab-pane fade show active" id="nav-request" role="tabpanel" aria-labelledby="nav-request-tab">
          <form class="needs-validation" novalidate>
            <div class="mb-3">
              <label for="endpoint" class="form-label">Endpoint</label>
              <input type="email" class="form-control" id="endpoint" placeholder="http://" value="" required>
              <div class="invalid-feedback">
                The given data was not valid URL!
              </div>
            </div>
            <div class="mb-3">
              <label for="request-body" class="form-label">Request body (JSON)</label>
              <textarea class="form-control" id="request-body" rows="10" required>{
                "shipments": [
                    {
                        "shipment_id": "order-1",
                        "pickup_location": {
                            "longitude": 106.6798134,
                            "latitude": -6.2118778
                        },
                        "dropoff_location": {
                            "longitude": 106.634529,
                            "latitude": -6.190571
                        },
                        "pickup_address": "jl.A",
                        "dropff_address": "jl.B",
                        "constraints": {
                            "pickup_time_windows": {
                                "start_time": "2023-01-04T08:00:57.4625198Z",
                                "end_time": "2023-01-04T11:15:57.4625198Z"
                            },
                            "dropoff_time_windows": {
                                "start_time": "2023-01-04T12:00:57.4625198Z",
                                "end_time": "2023-01-04T19:43:57.4625198Z"
                            },
                            "demand": [
                                {
                                    "type": 1,
                                    "demand": 1
                                },
                                {
                                    "type": 2,
                                    "demand": 10
                                },
                                {
                                    "type": 3,
                                    "demand": 2
                                }
                            ]
                        },
                        "info": "Test"
                    },
                    {
                        "shipment_id": "order-2",
                        "pickup_location": {
                            "longitude": 106.698674,
                            "latitude": -6.194309
                        },
                        "dropoff_location": {
                            "longitude": 106.736148,
                            "latitude": -6.186608
                        },
                        "pickup_address": "jl.A",
                        "dropff_address": "jl.B",
                        "constraints": {
                            "pickup_time_windows": {
                                "start_time": "2023-01-04T08:00:57.4625198Z",
                                "end_time": "2023-01-04T10:15:57.4625198Z"
                            },
                            "dropoff_time_windows": {
                                "start_time": "2023-01-04T15:00:57.4625198Z",
                                "end_time": "2023-01-04T18:43:57.4625198Z"
                            },
                            "demand": [
                                {
                                    "type": 1,
                                    "demand": 1
                                },
                                {
                                    "type": 2,
                                    "demand": 10
                                },
                                {
                                    "type": 3,
                                    "demand": 2
                                }
                            ]
                        },
                        "info": "Test"
                    },
                    {
                        "shipment_id": "order-3",
                        "pickup_location": {
                            "longitude": 106.726408,
                            "latitude": -6.134725
                        },
                        "dropoff_location": {
                            "longitude": 106.710375,
                            "latitude": -6.124574
                        },
                        "pickup_address": "jl.A",
                        "dropff_address": "jl.B",
                        "constraints": {
                            "pickup_time_windows": {
                                "start_time": "2023-01-04T07:00:57.4625198Z",
                                "end_time": "2023-01-04T10:15:57.4625198Z"
                            },
                            "dropoff_time_windows": {
                                "start_time": "2023-01-04T13:00:57.4625198Z",
                                "end_time": "2023-01-04T17:43:57.4625198Z"
                            },
                            "demand": [
                                {
                                    "type": 1,
                                    "demand": 1
                                },
                                {
                                    "type": 2,
                                    "demand": 10
                                },
                                {
                                    "type": 3,
                                    "demand": 2
                                }
                            ]
                        },
                        "info": "Test"
                    },
                    {
                        "shipment_id": "order-4",
                        "pickup_location": {
                            "longitude": 106.755641,
                            "latitude": -6.138218
                        },
                        "dropoff_location": {
                            "longitude": 106.747555,
                            "latitude": -6.091952
                        },
                        "pickup_address": "jl.A",
                        "dropff_address": "jl.B",
                        "constraints": {
                            "pickup_time_windows": {
                                "start_time": "2023-01-04T08:00:57.4625198Z",
                                "end_time": "2023-01-04T10:15:57.4625198Z"
                            },
                            "dropoff_time_windows": {
                                "start_time": "2023-01-04T10:00:57.4625198Z",
                                "end_time": "2023-01-04T17:43:57.4625198Z"
                            },
                            "demand": [
                                {
                                    "type": 1,
                                    "demand": 1
                                },
                                {
                                    "type": 2,
                                    "demand": 10
                                },
                                {
                                    "type": 3,
                                    "demand": 2
                                }
                            ]
                        },
                        "info": "Test"
                    },
                    {
                        "shipment_id": "order-5",
                        "pickup_location": {
                            "longitude": 106.870725,
                            "latitude": -6.33033
                        },
                        "dropoff_location": {
                            "longitude": 106.783718,
                            "latitude": -6.244204
                        },
                        "pickup_address": "jl.A",
                        "dropff_address": "jl.B",
                        "constraints": {
                            "pickup_time_windows": {
                                "start_time": "2023-01-04T08:00:57.4625198Z",
                                "end_time": "2023-01-04T10:15:57.4625198Z"
                            },
                            "dropoff_time_windows": {
                                "start_time": "2023-01-04T10:00:57.4625198Z",
                                "end_time": "2023-01-04T17:43:57.4625198Z"
                            },
                            "demand": [
                                {
                                    "type": 1,
                                    "demand": 1
                                },
                                {
                                    "type": 2,
                                    "demand": 10
                                },
                                {
                                    "type": 3,
                                    "demand": 2
                                }
                            ]
                        },
                        "info": "Test"
                    },
                    {
                        "shipment_id": "order-6",
                        "pickup_location": {
                            "longitude": 106.783529,
                            "latitude": -6.244179
                        },
                        "dropoff_location": {
                            "longitude": 106.789617,
                            "latitude": -6.176495
                        },
                        "pickup_address": "jl.A",
                        "dropff_address": "jl.B",
                        "constraints": {
                            "pickup_time_windows": {
                                "start_time": "2023-01-04T08:00:57.4625198Z",
                                "end_time": "2023-01-04T10:15:57.4625198Z"
                            },
                            "dropoff_time_windows": {
                                "start_time": "2023-01-04T10:00:57.4625198Z",
                                "end_time": "2023-01-04T17:43:57.4625198Z"
                            },
                           "demand": [
                                {
                                    "type": 1,
                                    "demand": 1
                                },
                                {
                                    "type": 2,
                                    "demand": 10
                                },
                                {
                                    "type": 3,
                                    "demand": 2
                                }
                            ]
                        },
                        "info": "Test"
                    },
                    {
                        "shipment_id": "order-7",
                        "pickup_location": {
                            "longitude": 106.731514,
                            "latitude": -6.276546
                        },
                        "dropoff_location": {
                            "longitude": 106.858623,
                            "latitude": -6.21038
                        },
                        "pickup_address": "jl.A",
                        "dropff_address": "jl.B",
                        "constraints": {
                            "pickup_time_windows": {
                                "start_time": "2023-01-04T08:00:57.4625198Z",
                                "end_time": "2023-01-04T10:15:57.4625198Z"
                            },
                            "dropoff_time_windows": {
                                "start_time": "2023-01-04T10:00:57.4625198Z",
                                "end_time": "2023-01-04T17:43:57.4625198Z"
                            },
                            "demand": [
                                {
                                    "type": 1,
                                    "demand": 1
                                },
                                {
                                    "type": 2,
                                    "demand": 10
                                },
                                {
                                    "type": 3,
                                    "demand": 2
                                }
                            ]
                        },
                        "info": "Test"
                    },
                    {
                        "shipment_id": "order-8",
                        "pickup_location": {
                            "longitude": 106.781693,
                            "latitude": -6.266588
                        },
                        "dropoff_location": {
                            "longitude": 106.783549,
                            "latitude": -6.19977
                        },
                        "pickup_address": "jl.A",
                        "dropff_address": "jl.B",
                        "constraints": {
                            "pickup_time_windows": {
                                "start_time": "2023-01-04T08:00:57.4625198Z",
                                "end_time": "2023-01-04T10:15:57.4625198Z"
                            },
                            "dropoff_time_windows": {
                                "start_time": "2023-01-04T10:00:57.4625198Z",
                                "end_time": "2023-01-04T17:43:57.4625198Z"
                            },
                            "demand": [
                                {
                                    "type": 1,
                                    "demand": 1
                                },
                                {
                                    "type": 2,
                                    "demand": 10
                                },
                                {
                                    "type": 3,
                                    "demand": 2
                                }
                            ]
                        },
                        "info": "Test"
                    }
                ],
                "vehicles": [
                    {
                        "vehicle_id": "vehicle-1",
                        "capacities": [
                            {
                                "type": 1,
                                "capacity": 5
                            },
                            {
                                "type": 2,
                                "capacity": 50
                            },
                            {
                                "type": 3,
                                "capacity": 5
                            }
                        ],
                        "start_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "end_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "load_time": 10,
                        "unload_time": 10,
                        "time_working": {
                            "start_time": "2023-01-04T07:43:57.4625198Z",
                            "end_time": "2023-01-04T18:43:57.4625198Z"
                        }
                    },
                    {
                        "vehicle_id": "vehicle-2",
                        "capacities": [
                            {
                                "type": 1,
                                "capacity": 5
                            },
                            {
                                "type": 2,
                                "capacity": 50
                            },
                            {
                                "type": 3,
                                "capacity": 5
                            }
                        ],
                        "start_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "end_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "load_time": 10,
                        "unload_time": 20,
                        "time_working": {
                            "start_time": "2023-01-04T18:43:57.4625198Z",
                            "end_time": "2023-01-04T23:43:57.4625198Z"
                        }
                    },
                    {
                        "vehicle_id": "vehicle-3",
                        "capacities": [
                            {
                                "type": 1,
                                "capacity": 5
                            },
                            {
                                "type": 2,
                                "capacity": 50
                            },
                            {
                                "type": 3,
                                "capacity": 5
                            }
                        ],
                        "start_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "end_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "load_time": 20,
                        "unload_time": 10,
                        "time_working": {
                            "start_time": "2023-01-04T18:43:57.4625198Z",
                            "end_time": "2023-01-04T23:43:57.4625198Z"
                        }
                    },
                    {
                        "vehicle_id": "vehicle-4",
                        "capacities": [
                            {
                                "type": 1,
                                "capacity": 5
                            },
                            {
                                "type": 2,
                                "capacity": 50
                            },
                            {
                                "type": 3,
                                "capacity": 5
                            }
                        ],
                        "start_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "end_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "load_time": 20,
                        "unload_time": 20,
                        "time_working": {
                            "start_time": "2023-01-04T18:43:57.4625198Z",
                            "end_time": "2023-01-04T23:43:57.4625198Z"
                        }
                    },
                    {
                        "vehicle_id": "vehicle-5",
                        "capacities": [
                            {
                                "type": 1,
                                "capacity": 5
                            },
                            {
                                "type": 2,
                                "capacity": 50
                            },
                            {
                                "type": 3,
                                "capacity": 5
                            }
                        ],
                        "start_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "end_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "load_time": 10,
                        "unload_time": 10,
                        "time_working": {
                            "start_time": "2023-01-04T18:43:57.4625198Z",
                            "end_time": "2023-01-04T23:43:57.4625198Z"
                        }
                    },
                    {
                        "vehicle_id": "vehicle-6",
                        "capacities": [
                            {
                                "type": 1,
                                "capacity": 5
                            },
                            {
                                "type": 2,
                                "capacity": 50
                            },
                            {
                                "type": 3,
                                "capacity": 5
                            }
                        ],
                        "start_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "end_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "load_time": 10,
                        "unload_time": 20,
                        "time_working": {
                            "start_time": "2023-01-04T18:43:57.4625198Z",
                            "end_time": "2023-01-04T23:43:57.4625198Z"
                        }
                    },
                    {
                        "vehicle_id": "vehicle-7",
                        "capacities": [
                            {
                                "type": 1,
                                "capacity": 5
                            },
                            {
                                "type": 2,
                                "capacity": 50
                            },
                            {
                                "type": 3,
                                "capacity": 5
                            }
                        ],
                        "start_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "end_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "load_time": 20,
                        "unload_time": 10,
                        "time_working": {
                            "start_time": "2023-01-04T18:43:57.4625198Z",
                            "end_time": "2023-01-04T23:43:57.4625198Z"
                        }
                    },
                    {
                        "vehicle_id": "vehicle-8",
                        "capacities": [
                            {
                                "type": 1,
                                "capacity": 5
                            },
                            {
                                "type": 2,
                                "capacity": 50
                            }
                        ],
                        "start_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "end_location": {
                            "longitude": 106.82559983687916,
                            "latitude": -6.246147633124191
                        },
                        "load_time": 20,
                        "unload_time": 20,
                        "time_working": {
                            "start_time": "2023-01-04T18:43:57.4625198Z",
                            "end_time": "2023-01-04T23:43:57.4625198Z"
                        }
                    }
                ]
            }</textarea>
              <div class="invalid-feedback">
                The given data was not valid JSON!
              </div>
            </div>
            <div class="mb-3 text-end">
              <button type="submit" id="btn-request" class="btn btn-primary">Request and draw</button>
            </div>
          </form>
        </div>
        <div class="tab-pane fade" id="nav-json" role="tabpanel" aria-labelledby="nav-json-tab">
          <form class="needs-validation" novalidate>
            <div class="mb-3">
              <label for="json-input" class="form-label">JSON</label>
              <textarea class="form-control" id="json-input" rows="15" required></textarea>
              <div class="invalid-feedback">
                The given data was not valid JSON!
              </div>
            </div>
            <div class="mb-3 text-end">
              <button type="submit" id="btn-draw-waypoints" class="btn btn-primary">Draw waypoints</button>
            </div>
          </form>
        </div>
      </div>
    </aside>
    <script src="https://cdn.jsdelivr.net/npm/elm-pep@1.0.6/dist/elm-pep.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@7.2.2/dist/ol.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/ol@v7.2.2/dist/ol.js"></script> -->
    <script src="https://unpkg.com/ol-mapbox-style@9.5.0/dist/olms.js"></script>
    <script src="https://unpkg.com/fast-equals@4.0.3/dist/fast-equals.min.js"></script>
    <script>
      'use strict';

      const $tab = document.querySelector('button[data-bs-toggle="tab"]');
      const $navRequest = document.querySelector('#nav-request');
      const $navJson = document.querySelector('#nav-json');
      const $endpointInput = document.querySelector('#endpoint');
      const $requestBodyInput = document.querySelector('#request-body');
      const $btnRequest = document.querySelector('#btn-request');
      const $jsonInput = document.querySelector('#json-input');
      const $btnDrawWaypoints = document.querySelector('#btn-draw-waypoints');

      const startMarkerIcon = 'http://maps.google.com/mapfiles/kml/shapes/ranger_station.png';
      const pickupMarkerIcon = 'http://maps.google.com/mapfiles/kml/paddle/orange-blank.png';
      const dropoffMarkerIcon = 'http://maps.google.com/mapfiles/kml/paddle/pink-blank.png';

      const alphabet = '?ABCDEFGHIJKLMNOPQRSTUVWXYZ';

      const requestLayers = [];
      const drawFromJsonLayers = [];

      async function drawRoutes(waypoints) {
        const layers = [];
        const coordParams = [];

        for (let i = 0; i < waypoints.length; i++) {
          const waypointGroup = waypoints[i];

          coordParams.push({
            param: waypointGroup.waypoints.reduce((acc, cur, j) => {
              const separator = j > 0 ? ';' : '';
              return acc + separator + cur.longitude + ',' + cur.latitude;
            }, ''),
            points: waypointGroup.waypoints.map((el) => ({
              latlon: [el.longitude, el.latitude],
              orderId: el.orderId,
              eta: el.eta,
              demand: el.demand,
              info: el.info,
              type: el.type,
              iconUrl: el.iconUrl,
            })),
          });
        }

        const promises = [];

        for (let i = 0; i < coordParams.length; i++) {
          promises.push(fetch('https://router.project-osrm.org/route/v1/driving/' + coordParams[i].param));
        }

        const results = await Promise.all(promises);
        const jsons = [];

        for (let i = 0; i < results.length; i++) {
          jsons.push(results[i].json());
        }

        const polylines = await Promise.all(jsons);

        for (let i = 0; i < polylines.length; i++) {
          const polyline = polylines[i].routes[0].geometry;

          const route = new ol.format.Polyline({ factor: 1e5 })
            .readGeometry(polyline, {
              dataProjection: 'EPSG:4326',
              featureProjection: 'EPSG:3857',
            });

          const routeFeature = new ol.Feature({
            type: 'route',
            geometry: route,
          });

          const isEqualStartEnd = window['fast-equals'].deepEqual(route.getFirstCoordinate(), route.getLastCoordinate());

          const markers = [];

          for (let j = 0; j < coordParams[i].points.length; j++) {
            const itemPoint = coordParams[i].points[j];
            markers.push(new ol.Feature({
              type: alphabet.charAt(j) + 'Marker',
              geometry: new ol.geom.Point(ol.proj.fromLonLat(itemPoint.latlon)),
              data: {
                orderId: itemPoint?.orderId,
                eta: itemPoint?.eta,
                demand: itemPoint?.demand,
                info: itemPoint?.info,
                type: itemPoint?.type,
                iconUrl: itemPoint?.iconUrl,
              },
            }));
          }

          const position = markers[0].getGeometry().clone();

          const geoMarker = new ol.Feature({
            type: 'geoMarker',
            geometry: position,
          });

          const styles = {
            'route': new ol.style.Style({
              stroke: new ol.style.Stroke({
                width: 5,
                color: waypoints[i].color,
              }),
            }),
            'geoMarker': new ol.style.Style({
              image: new ol.style.Circle({
                radius: 7,
                fill: new ol.style.Fill({ color: getRandomColor() }),
                stroke: new ol.style.Stroke({
                  color: 'white',
                  width: 2,
                }),
              }),
            }),
          };

          for (let j = 0; j < markers.length - (isEqualStartEnd ? 1 : 0); j++) {
            const key = alphabet.charAt(j);
            const pointMarkerIcon = key === 'A' ? pickupMarkerIcon : dropoffMarkerIcon;

            Object.assign(styles, {
              [key + 'Marker']: new ol.style.Style({
                image: new ol.style.Icon({
                  anchor: [0.5, 1],
                  src: markers[j]?.get('data')?.iconUrl || pointMarkerIcon,
                  scale: 0.7,
                }),
                text: new ol.style.Text({
                  text: key === '?' || j === markers.length - 1 ? '' : key,
                  offsetY: -32,
                  scale: 1.5,
                  fill: new ol.style.Fill({
                    color: 'white',
                    width: 2,
                  }),
                  stroke: new ol.style.Stroke({
                    color: 'white',
                    width: 1,
                  }),
                }),
              }),
            });
          }

          const vectorLayer = new ol.layer.Vector({
            name: 'route' + i,
            source: new ol.source.Vector({
              features: [routeFeature, geoMarker].concat(markers),
            }),
            style: function (feature) {
              return styles[feature?.get?.('type')];
            },
          });

          map.addLayer(vectorLayer);
          layers.push(vectorLayer);

          let animating = false;
          let distance = 0;
          let lastTime;

          function moveFeature(event) {
            const speed = 60;
            const time = event.frameState.time;
            const elapsedTime = time - lastTime;
            distance = (distance + (speed * elapsedTime) / 1e6) % 2;
            lastTime = time;

            const currentCoordinate = route.getCoordinateAt(
              distance > 1 ? distance - 1 : distance
            );

            position.setCoordinates(currentCoordinate);
            const vectorContext = ol.render.getVectorContext(event);
            vectorContext.setStyle(styles.geoMarker);
            vectorContext.drawGeometry(position);
            // tell OpenLayers to continue the postrender animation
            map.render();
          }

          function startAnimation() {
            animating = true;
            lastTime = Date.now();
            vectorLayer.on('postrender', moveFeature);
            // hide geoMarker and trigger map render through change event
            geoMarker.setGeometry(null);
          }

          function stopAnimation() {
            animating = false;

            // Keep marker at current animation position
            geoMarker.setGeometry(position);
            vectorLayer.un('postrender', moveFeature);
          }

          startAnimation();
        }

        return layers;
      }

      const map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM(),
          }),
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([106.710375, -6.124574]),
          zoom: 12,
          padding: [0, 0, 0, 400],
        }),
      });

      map.addLayer(new ol.layer.MapboxVector({
        styleUrl: 'mapbox://styles/lulukishere/cldmz3fjx000l01qptx3e9vsm',
        accessToken: 'pk.eyJ1IjoibHVsdWtpc2hlcmUiLCJhIjoiY2o4b3U2d2FmMDhzczMycGN1N3RveHE1ciJ9.AuIJ5oB-IKcUiD8y2ltZLQ'
      }));

      const $popup = document.querySelector('#popup');

      const popup = new ol.Overlay({
        element: $popup,
        stopEvent: false,
      });
      map.addOverlay(popup);

      function createPopoverContent({ coordinate, orderId, eta, demand, info, type }) {
        const latlon = ol.proj.transform(coordinate, 'EPSG:3857', 'EPSG:4326');
        const demandLabel = createLabelFor('demand', demand);

        return `
          <table style="width: 250px;">
            <tbody>
              <tr><th>Order ID</th><td>${orderId || '-'}</td></tr>
              <tr><th>ETA</th><td>${new Date(eta).toLocaleString()}</td></tr>
              <tr><th>Demand</th><td>${demandLabel}</td></tr>
              <tr><th>Info</th><td>${info || '-'}</td></tr>
              <tr><th>Type</th><td>${type || '-'}</td></tr>
              <tr><th>Latlon</th><td><small>${latlon[0]?.toFixed?.(6)},${latlon[1]?.toFixed?.(6)}</small></td></tr>
            </tbody>
          </table>`;
      }

      let popover;
      map.on('click', (e) => {
        if (popover) {
          popover.dispose();
          popover = undefined;
        }
        const feature = map.getFeaturesAtPixel(e.pixel)[0];

        if (!feature) return;

        const coordinate = feature?.getGeometry?.()?.getCoordinates?.();
        const { orderId, eta, demand, info, type } = feature?.get?.('data') || {};

        if (!coordinate) return;

        popup.setPosition([coordinate[0], coordinate[1]]);

        popover = new bootstrap.Popover($popup, {
          container: $popup.parentElement,
          content: createPopoverContent({ coordinate, orderId, eta, demand, info, type }),
          html: true,
          offset: [0, 20],
          placement: 'top',
          sanitize: false,
        });
        popover.show();
      });

      map.on('pointermove', (e) => {
        const type = map.hasFeatureAtPixel(e.pixel) ? 'pointer' : 'inherit';
        map.getViewport().style.cursor = type;
      });

      $endpointInput.addEventListener('keyup', (e) => {
        if (!isValidUrl(e.target.value)) {
          e.target.classList.add('is-invalid');
        } else {
          e.target.classList.remove('is-invalid');
        }
      });

      $requestBodyInput.addEventListener('keyup', (e) => {
        if (!isValidJson(e.target.value)) {
          e.target.classList.add('is-invalid');
        } else {
          e.target.classList.remove('is-invalid');
        }
      });

      const requestShowRoute = new Map();
      let $checkAllRequestWrapper;
      let $dividerRequest;

      $btnRequest.addEventListener('click', (e) => {
        document.querySelector('#res-title-request')?.remove?.();
        document.querySelectorAll('.form-check-request').forEach((el) => el?.remove?.());

        if ($checkAllRequestWrapper) {
          $checkAllRequestWrapper.remove();
        }
        if ($dividerRequest) {
          $dividerRequest.remove();
        }

        void (async () => {
          if (!$requestBodyInput.value?.trim?.()) return;

          e.target.setAttribute('disabled', true);
          e.target.textContent = 'Loading...';

          requestLayers.forEach(l => {
            map.removeLayer(l);
          });
          requestLayers.splice(0); // clear

          const data = isValidJson($requestBodyInput.value) ? JSON.parse($requestBodyInput.value) : '';

          try {
            const res = await fetch($endpointInput.value, {
              method: 'POST',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(data),
            });

            const json = await res.json();

            if (res.status !== 200) {
              alert(json?.message || 'Oops! Something went wrong.');
            }

            const waypoints = createWaypoint(json?.routes);

            const layers = await drawRoutes(waypoints);

            const $title = document.createElement('h5');
            $title.setAttribute('id', 'res-title-request');
            $title.appendChild(document.createTextNode('Routes'));

            const $divider = document.createElement('hr');
            $divider.classList.add('mt-1');
            $dividerRequest = $divider;

            $checkAllRequestWrapper = createCheckboxToggleAll('request');
            $checkAllRequestWrapper.classList.add('float-end');

            $checkAllRequestWrapper
              .children
              .item(0)
              .addEventListener('change', (e) => {
                document.querySelectorAll('.form-check-input-request').forEach((el) => {
                  el.setAttribute('checked', e.target.checked);
                  el.checked = e.target.checked;
                });

                if (!e.target.checked) {
                  requestLayers.forEach((l, i) => {
                    map.removeLayer(l);
                    requestShowRoute.set(i, false);
                  });
                } else {
                  requestLayers.forEach((l, i) => {
                    map.addLayer(l);
                    requestShowRoute.set(i, true);
                  });
                }
              });

            const $titleWrapper = document.createElement('div');
            $titleWrapper.classList.add('clearfix', 'mt-1');

            $titleWrapper.appendChild($checkAllRequestWrapper);
            $titleWrapper.appendChild($title);

            $navRequest.appendChild($titleWrapper);
            $navRequest.appendChild($divider);
            
            layers.forEach((l, i) => {
              requestLayers.push(l);
              requestShowRoute.set(i, true);

              createRouteCheckbox(i, 'request', waypoints);
            });

            const $checkboxRoutes = document.querySelectorAll('.form-check-input-request');

            $checkboxRoutes.forEach((el, i) => {
              el.addEventListener('change', (cbx) => {
                cbx.target.setAttribute('checked', cbx.target.checked);

                const leyerIndex = Number(cbx.target.getAttribute('data-index'));

                requestShowRoute.set(leyerIndex, cbx.target.checked);

                if (!cbx.target.checked) {
                  map.removeLayer(layers[leyerIndex]);
                } else {
                  map.addLayer(layers[leyerIndex]);
                }

                let checkedCount = 0;
                const $cbxRoutes = document.querySelectorAll('.form-check-input-request');
                $cbxRoutes.forEach((el2) => {
                  if (el2.getAttribute('checked') === 'true') {
                    checkedCount++;
                  }
                });

                const $toggleAllRequest = document.querySelector('#toggle-all-request');

                if (checkedCount > 0 && checkedCount < $cbxRoutes.length) {
                  $toggleAllRequest.indeterminate = true;
                } else if (checkedCount === $cbxRoutes.length) {
                  $toggleAllRequest.indeterminate = false;
                  $toggleAllRequest.checked = true;
                } else if (checkedCount === 0) {
                  $toggleAllRequest.indeterminate = false;
                  $toggleAllRequest.checked = false;
                }
              });
            });
          } catch (error) {
            alert(error?.message || 'Oops! Something went wrong.');
          } finally {
            e.target.removeAttribute('disabled');
            e.target.textContent = 'Request and draw';
          }
        })();
      });

      $jsonInput.addEventListener('keyup', (e) => {
        validateJsonInput(e, $btnDrawWaypoints);
      });

      const jsonShowRoute = new Map();
      let $checkAllJsonWrapper;
      let $dividerJson;

      $btnDrawWaypoints.addEventListener('click', (e) => {
        if (!$jsonInput.value?.trim?.()) return;

        document.querySelector('#res-title-json')?.remove?.();
        document.querySelectorAll('.form-check-json').forEach((el) => el?.remove?.());

        if ($checkAllJsonWrapper) {
          $checkAllJsonWrapper.remove();
        }
        if ($dividerJson) {
          $dividerJson.remove();
        }

        void (async () => {
          e.target.setAttribute('disabled', true);
          e.target.textContent = 'Loading...';

          drawFromJsonLayers.forEach(l => {
            map.removeLayer(l);
          });
          drawFromJsonLayers.splice(0); // clear

          const json = JSON.parse($jsonInput.value);
          const waypoints = createWaypoint(json?.routes);

          const layers = await drawRoutes(waypoints);

          const $title = document.createElement('h5');
          $title.setAttribute('id', 'res-title-json');
          $title.appendChild(document.createTextNode('Routes'));

          const $divider = document.createElement('hr');
          $divider.classList.add('mt-1');
          $dividerJson = $divider;

          $checkAllJsonWrapper = createCheckboxToggleAll('json');
          $checkAllJsonWrapper.classList.add('float-end');

          $checkAllJsonWrapper
            .children
            .item(0)
            .addEventListener('change', (e) => {
              document.querySelectorAll('.form-check-input-json').forEach((el) => {
                el.setAttribute('checked', e.target.checked);
                el.checked = e.target.checked;
              });

              if (!e.target.checked) {
                drawFromJsonLayers.forEach((l, i) => {
                  map.removeLayer(l);
                  jsonShowRoute.set(i, false);
                });
              } else {
                drawFromJsonLayers.forEach((l, i) => {
                  map.addLayer(l);
                  jsonShowRoute.set(i, true);
                });
              }
            });

          const $titleWrapper = document.createElement('div');
          $titleWrapper.classList.add('clearfix', 'mt-4');

          $titleWrapper.appendChild($checkAllJsonWrapper);
          $titleWrapper.appendChild($title);

          $navJson.appendChild($titleWrapper);
          $navJson.appendChild($divider);

          layers.forEach((l, i) => {
            drawFromJsonLayers.push(l);
            jsonShowRoute.set(i, true);

            createRouteCheckbox(i, 'json', waypoints);
          });

          e.target.removeAttribute('disabled');
          e.target.textContent = 'Draw waypoints';

          const $checkboxRoutes = document.querySelectorAll('.form-check-json');

          $checkboxRoutes.forEach((el, i) => {
            el.addEventListener('change', (cbx) => {
              const leyerIndex = Number(cbx.target.getAttribute('data-index'));

              jsonShowRoute.set(leyerIndex, cbx.target.checked);

              if (!cbx.target.checked) {
                map.removeLayer(layers[leyerIndex]);
              } else {
                map.addLayer(layers[leyerIndex]);
              }
            });
          });
        })();
      });

      const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
      const popoverList = popoverTriggerList.map((popoverTriggerEl) => new bootstrap.Popover(popoverTriggerEl));

      const $forms = document.querySelectorAll('.needs-validation');

      Array.prototype.slice.call($forms)
        .forEach((form) => {
          form.addEventListener('submit', (event) => {
            event.preventDefault();
            event.stopPropagation();
          }, false);
        });

      $tab.addEventListener('show.bs.tab', (e) => {
        drawFromJsonLayers.forEach(l => {
          map.removeLayer(l);
        });

        requestLayers.forEach((l, i) => {
          if (requestShowRoute.get(i)) {
            map.addLayer(l);
          }
        });
      });

      $tab.addEventListener('hide.bs.tab', (e) => {
        requestLayers.forEach(l => {
          map.removeLayer(l);
        });
        drawFromJsonLayers.forEach((l, i) => {
          if (jsonShowRoute.get(i)) {
            map.addLayer(l);
          }
        });
      });

      function createLabelFor(key = '', value = []) {
        return value.reduce((acc, cur, i, arr) => {
          const separator = i < arr.length - 1 ? ', ' : '';
          switch (cur.type) {
            case 1:
              return acc + 'D: ' + cur[key] + separator;
              break;
            case 2:
              return acc + 'W: ' + cur[key] + separator;
              break;
            case 3:
              return acc + 'P: ' + cur[key] + separator;
              break;
            default:
              break;
          }
        }, '');
      }

      function createCheckboxToggleAll(id) {
        const elementId = 'toggle-all-' + id;

        const $wrapper = document.createElement('div');
        $wrapper.classList.add('form-check');

        const $input = document.createElement('input');
        $input.setAttribute('type', 'checkbox');
        $input.classList.add('form-check-input');
        $input.setAttribute('id', elementId);
        $input.setAttribute('checked', true);

        const $label = document.createElement('label');
        $label.setAttribute('for', elementId);
        $label.appendChild(document.createTextNode('Toggle all'));

        $wrapper.appendChild($input);
        $wrapper.appendChild($label);

        return $wrapper;
      }

      function createRouteCheckbox(i, tabId, waypoints) {
        const checkboxId = 'checkbox-route-' + tabId + '-' + i;

        const $formCheck = document.createElement('div');
        $formCheck.classList.add('form-check', 'form-check-inline', 'form-check-' + tabId);

        const popoverContent = createLabelFor('capacity', waypoints[i].capacities);

        $formCheck.setAttribute('data-bs-toggle', 'popover');
        $formCheck.setAttribute('data-bs-title', 'Capacity');
        $formCheck.setAttribute('data-bs-content', popoverContent);
        $formCheck.setAttribute('data-bs-trigger', 'hover');

        new bootstrap.Popover($formCheck);

        const $formCheckInput = document.createElement('input');
        $formCheckInput.classList.add('form-check-input');
        $formCheckInput.classList.add('form-check-input-' + tabId);
        $formCheckInput.setAttribute('type', 'checkbox');
        $formCheckInput.setAttribute('id', checkboxId);
        $formCheckInput.setAttribute('checked', true);
        $formCheckInput.setAttribute('data-index', i);
        $formCheckInput.style.backgroundColor = waypoints[i].color;
        $formCheckInput.style.borderColor = waypoints[i].color;

        const $formCheckLabel = document.createElement('label');
        $formCheckLabel.classList.add('form-check-label');
        $formCheckLabel.setAttribute('for', checkboxId);
        $formCheckLabel.appendChild(
          document.createTextNode('#' + waypoints[i].vehicleId),
        );

        const tooltip = new bootstrap.Tooltip($formCheckLabel);
        
        $formCheck.appendChild($formCheckInput);
        $formCheck.appendChild($formCheckLabel);
        if (tabId === 'json') {
          $navJson.appendChild($formCheck);
        } else {
          $navRequest.appendChild($formCheck);
        }
      }

      function createWaypoint(routes = []) {
        const waypoints = [];

        for (let i = 0; i < routes?.length; i++) {
          const itemRoute = routes[i];
          const waypointGroup = [];

          waypointGroup.push(Object.assign(
            {
              orderId: itemRoute.vehicle.vehicleId,
              iconUrl: startMarkerIcon,
            },
            itemRoute.vehicle.startLocation
          ));

          for (let j = 0; j < itemRoute?.visits.length; j++) {
            const itemVisit = itemRoute?.visits[j];
            const orderId = itemVisit.shipment.shipmentId;
            const eta = itemVisit.eta;
            const demand = itemVisit.demand;
            const info = itemVisit.shipment.info;

            if (itemVisit.type === 1) {
              waypointGroup.push(Object.assign(
                {
                  orderId,
                  eta,
                  demand,
                  info,
                  type: 'Pickup',
                  iconUrl: pickupMarkerIcon,
                },
                itemVisit.shipment.pickupLocation,
              ));
            } else {
              waypointGroup.push(Object.assign(
                { orderId, eta, demand, info, type: 'Dropoff' },
                itemVisit.shipment.dropoffLocation,
              ));
            }
          }

          waypointGroup.push(Object.assign(
            {
              iconUrl: startMarkerIcon,
            },
            itemRoute.vehicle.endLocation,
          ));

          waypoints.push({
            vehicleId: itemRoute.vehicle.vehicleId,
            capacities: itemRoute.vehicle.capacities,
            waypoints: waypointGroup,
            color: getRandomColor(),
          });
        }

        return waypoints;
      }

      function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';

        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }

        return color;
      }

      function isValidUrl(value) {
        try {
          new URL(value);
          return true;
        } catch (error) {
          return false;
        }
      }

      function isValidJson(value) {
        try {
          JSON.parse(value);
          return true;
        } catch (error) {
          return false;
        }
      }

      function validateJsonInput(event, button) {
        const jsonInputValue = event.target.value?.trim?.();

        try {
          if (jsonInputValue) {
            JSON.parse(jsonInputValue);
          }
          event.target.classList.remove('is-invalid');
          button.removeAttribute('disabled');
        } catch (error) {
          event.target.classList.add('is-invalid');
          button.setAttribute('disabled', true);
        }
      }

      function createUrl(endpoint, query) {
        let url = endpoint;
        let params;

        try {
          params = new URLSearchParams(JSON.parse(query.trim?.())).toString();
        } catch (error) {}

        if (!params) return url;

        if (endpoint.includes('?')) {
          return endpoint + '&' + params;
        } else {
          return endpoint + '?' + params;
        }
      }
    </script>
  </body>
</html>